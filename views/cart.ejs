<%- include('partials/header') %>

<div class="container mt-4">
    <h2>Tu Carrito</h2>

    <% if (!cart || cart.length === 0) { %>
        <div class="alert alert-info">Tu carrito está vacío. <a href="/">Ir a comprar</a></div>
    <% } else { %>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="cart-body">
                <% cart.forEach(item => { %>
                    <tr id="row-<%= item.id %>">
                        <td><%= item.name %></td>
                        <td>$<%= item.price %></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="updateCart(<%= item.id %>, 'decrease')">-</button>
                            <span id="qty-<%= item.id %>" class="mx-2"><%= item.quantity %></span>
                            <button class="btn btn-sm btn-secondary" onclick="updateCart(<%= item.id %>, 'increase')">+</button>
                        </td>
                        <td id="subtotal-<%= item.id %>">$<%= (item.price * item.quantity).toFixed(2) %></td>
                        <td><button class="btn btn-danger btn-sm" onclick="updateCart(<%= item.id %>, 'remove')">Eliminar</button></td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
        
        <h3 class="text-end">Total: $<span id="grand-total"><%= total.toFixed(2) %></span></h3>

        <% if (user) { %>
            <form action="/checkout" method="POST" class="text-end mt-3">
                <button type="submit" class="btn btn-success btn-lg">Pagar y Generar Ticket</button>
            </form>
        <% } else { %>
            <div class="alert alert-warning text-end mt-3">
                <a href="/login">Inicia sesión</a> para terminar tu compra.
            </div>
        <% } %>
    <% } %>
</div>

<script>
    function updateCart(id, action) {
        fetch('/update-cart', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, action })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('grand-total').innerText = data.total.toFixed(2);
                const item = data.cart.find(i => i.id == id);
                
                if (!item) {
                    document.getElementById(`row-${id}`).remove();
                } else {
                    document.getElementById(`qty-${id}`).innerText = item.quantity;
                    document.getElementById(`subtotal-${id}`).innerText = '$' + (item.price * item.quantity).toFixed(2);
                }
                if (data.cart.length === 0) location.reload();
            }
        });
    }
</script>

<%- include('partials/footer') %>